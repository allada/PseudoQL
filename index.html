<!DOCTYPE html>
<html>
    <head>
        <title>PsudoQL Proof of Concept Page</title>
        <script src="https://google.github.io/traceur-compiler/bin/traceur.js"></script>
        <script src="https://google.github.io/traceur-compiler/src/bootstrap.js"></script>
        <style type="text/css">
            th {
                width: 85px;
                text-align:left;
                font-size:12pt;
            }
            td, th{
                vertical-align: top;
            }
            #select_table th, #select_table td {
                font-size:12pt;
                text-align:center;
            }
            body {
                zoom: 2;
            }
        </style>
    </head>
    <body>
        <table border="0" width="100%" cellpadding="0" cellspacing="0">
            <tr>
                <th>Query:</th>
                <td><input type="text" id="query" style="width:300px;" value="sum(order_total)>500 customer.id!:- customer.name~John" /></td>
            </tr>
            <tr>
                <th>Table:</th>
                <td><select id="table"></select></td>
            </tr>
            <tr>
                <th>Group By:</th>
                <td><input type="text" id="group_by" style="width:300px;" /></td>
            </tr>
            <tr>
                <th>Order Bys:</th>
                <td><table border="0" cellpadding="0" cellspacing="0" id="order_table" width="308px">
                    <tr>
                        <th style="width:65%;">Query</th>
                        <th style="width:20%;">Dir</th>
                        <td style="width:10%;"><input type="button" value="+" onclick="addOrderBy()" /></td>
                    </tr>
                    <tr>
                        <th><input type="text" name="order_values[]" style="width:95%;" value="customer.name" /></th>
                        <th colspan="2"><select name="order_dirs[]" style="width:95%;">
                            <option value="asc">ASC</option>
                            <option value="desc">DESC</option>
                        </select></th>
                    </tr>
                </table></td>
            </tr>
            <tr>
                <td colspan="2">&nbsp;</td>
            </tr>
            <tr>
                <th>Selects:</th>
                <td><table border="0" cellpadding="0" cellspacing="0" id="select_table" width="308px">
                    <tr>
                        <th style="width:20%;">Name</th>
                        <th style="width:65%;">Query</th>
                        <td style="width:10%;"><input type="button" value="+" onclick="addSelects()" /></td>
                    </tr>
                    <tr>
                        <th><input type="text" name="select_names[]" style="width:95%;" value="order_id" /></th>
                        <th colspan="2"><input type="text" name="select_values[]" style="width:95%;" value="id" /></th>
                    </tr>
                    <tr>
                        <th><input type="text" name="select_names[]" style="width:95%;" value="ship_info" /></th>
                        <th colspan="2"><input type="text" name="select_values[]" style="width:95%;" value="concat(customer.name, '\n', customer.address1, if(customer.address2, concat('\n', customer.address2)), '\n', customer.city, ' ', customer.state, ' ', customer.postalcode)" /></th>
                    </tr>
                    <tr>
                        <th><input type="text" name="select_names[]" style="width:95%;" value="total" /></th>
                        <th colspan="2"><input type="text" name="select_values[]" style="width:95%;" value="sum(order_total)" /></th>
                    </tr>
                </table></td>
            </tr>
            <tr>
                <td colspan="2"><hr /></td>
            </tr>
            <tr>
                <th style="height:200px;">Output:</th>
                <td><div id="output_query" style="width:80%;height:300px;border:1px solid black;white-space:pre;font-size:8pt;font-family:monospace;overflow:auto;"></div></td>
            </tr>
        </table>
        <!-- <textarea id="psudoql" style="width:100%;height:300px"></textarea>
        <textarea id="output" style="width:100%;height:300px"></textarea> -->
        <script type="module">
            import { PQL } from './pql/PQL.js';
            import { Config } from './pql/config.js';
            (() => {
                let output_query_el, query_el, table_el, group_by_el, select_names, select_values, order_dirs, order_values;

                function refreshMappings () {
                    output_query_el = document.getElementById('output_query');
    
                    query_el    = document.getElementById('query');
                    table_el    = document.getElementById('table');
                    group_by_el = document.getElementById('group_by');
    
                    select_names = document.getElementsByName('select_names[]');
                    select_values = document.getElementsByName('select_values[]');
    
                    order_dirs = document.getElementsByName('order_dirs[]');
                    order_values = document.getElementsByName('order_values[]');

                    PQL.setDefaultConfig(Config);
                    while (table_el.firstChild) {
                        table_el.removeChild(table_el.firstChild);
                    }
                    for (let i in Config.DB_MAP) {
                        if (Config.DB_MAP.hasOwnProperty(i)) {
                            let option = document.createElement('option');
                            option.value = i;
                            option.appendChild(document.createTextNode(i));
                            table_el.appendChild(option);
                        }
                    }

                    let listenerObjects = new Set;

                    listenerObjects.add(query_el);
                    listenerObjects.add(table_el);
                    listenerObjects.add(group_by_el);
    
                    for (let i of Object.keys(select_names)) {
                        listenerObjects.add(select_names[i]);
                        listenerObjects.add(select_values[i]);
                    }

                    for (let i of Object.keys(order_values)) {
                        listenerObjects.add(order_dirs[i]);
                        listenerObjects.add(order_values[i]);
                    }
    
                    listenerObjects.forEach((v, k) => {
                        v.removeEventListener('change', runQuery);
                        v.addEventListener('change', runQuery);
                        v.removeEventListener('keyup', runQuery);
                        v.addEventListener('keyup', runQuery);
                        v.removeEventListener('paste', runQuery);
                        v.addEventListener('paste', runQuery);
                        v.removeEventListener('input', runQuery);
                        v.addEventListener('input', runQuery);
                    });
                    runQuery();
                }
                let runQuery = function () {
                    try {
                        let fields = {};
                        for (let i of Object.keys(select_names)) {
                            fields[select_names[i].value === '' ? Symbol() : select_names[i].value] = select_values[i].value;
                        }
    
                        let orders = {};
                        for (let i of Object.keys(order_values)) {
                            orders[order_values[i].value] = order_dirs[i].value;
                        }
                        let query = PQL.getSQL({
                            query: query_el.value,
                            table: table_el.value,
                            group: group_by_el.value,
                            selects: fields,
                            orderBys: orders,
                        });
                        while (output_query_el.firstChild) {
                            output_query_el.removeChild(output_query_el.firstChild);
                        }
                        output_query_el.appendChild(document.createTextNode(query));
                    } catch (e) {
                        while (output_query_el.firstChild) {
                            output_query_el.removeChild(output_query_el.firstChild);
                        }
    
                        if (e instanceof Array) {
                            output_query_el.appendChild(document.createTextNode(e[0]));
                            output_query_el.appendChild(document.createElement('br'));
                            output_query_el.appendChild(document.createElement('br'));
    
                            let span1 = output_query_el.appendChild(document.createElement('span'));
                            let span2 = output_query_el.appendChild(document.createElement('span'));
                            span1.appendChild(document.createTextNode(e[2].substr(0, e[1])));
                            span2.appendChild(document.createTextNode(e[2].substr(e[1])));
    
                            span2.style.backgroundColor = '#EEE';
                        } else {
                            output_query_el.appendChild(document.createTextNode(e.message || e));
                        }
                        return;
                    }
                };
                window.addSelects = () => {
                    var select_table = document.getElementById('select_table');
                    var tr = select_table.appendChild(document.createElement('tr'));
                    var td1 = tr.appendChild(document.createElement('td'));
                    var td2 = tr.appendChild(document.createElement('td'));

                    var input1 = td1.appendChild(document.createElement('input'));
                    var input2 = td2.appendChild(document.createElement('input'));

                    input1.type = 'text';
                    input1.name = 'select_names[]';
                    input1.style.width = '95%';

                    input2.type = 'text';
                    input2.name = 'select_values[]';
                    input2.style.width = '95%';

                    td2.colSpan = 2;

                    refreshMappings();
                };

                window.addOrderBy = () => {
                    var order_table = document.getElementById('order_table');
                    var tr = order_table.appendChild(document.createElement('tr'));
                    var td1 = tr.appendChild(document.createElement('td'));
                    var td2 = tr.appendChild(document.createElement('td'));

                    var input = td1.appendChild(document.createElement('input'));
                    var select = td2.appendChild(document.createElement('select'));

                    input.type = 'text';
                    input.name = 'order_values[]';
                    input.style.width = '95%';

                    select.name = 'order_dirs[]';
                    select.style.width = '95%';

                    var asc = document.createElement('option');
                    var desc = document.createElement('option');
                    asc.value = 'asc';
                    desc.value = 'desc';
                    asc.appendChild(document.createTextNode('ASC'));
                    desc.appendChild(document.createTextNode('DESC'));

                    select.appendChild(asc);
                    select.appendChild(desc);

                    td2.colSpan = 2;

                    refreshMappings();
                };
            })();
            window.addSelects();
        </script>
    </body>
</html>